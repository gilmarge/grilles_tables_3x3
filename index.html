<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>G√©n√©rateur de grilles 3√ó3 ‚Äî tables de multiplication</title>
  <style>
    :root{--ink:#111;--grid:#000}
    *{box-sizing:border-box}
    body{margin:0;background:#fff;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:20px;margin:0;font-weight:700;letter-spacing:.2px}
    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .btn{appearance:none;border:1px solid #000;background:#f5f5f5;color:#000;font-weight:700;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.secondary{background:#fff}
    .card{background:#fff;border:1px solid #000;border-radius:10px;padding:14px}
    .grid{border-collapse:collapse;width:100%;table-layout:fixed}
    .grid td,.grid th{border:1px solid var(--grid);padding:8px;text-align:center;height:42px}
    .grid th{background:#f0f3ff;color:#000}
    .gridbox{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:10px}
    .level-title{margin:6px 0 8px 0;font-weight:700}
    .table-select{margin-bottom:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .table-select label{display:flex;align-items:center;gap:4px;background:#fff;padding:4px 8px;border:1px solid #000;border-radius:6px}
    hr{border:0;border-top:1px solid #000;margin:16px 0}
    .meta{display:flex;flex-wrap:wrap;gap:18px;align-items:center;margin:8px 0 6px 0}
    .meta .line{display:inline-block;border-bottom:2px solid #000;height:0;vertical-align:middle}
    .pdf-hide{display:none!important}
  /* PDF mode: agrandir les tableaux et cacher la s√©lection des tables */
  #sheet.pdf-mode .table-select{display:none!important}
  #sheet.pdf-mode .grid td, #sheet.pdf-mode .grid th{height:64px;padding:12px;font-size:18px}
  #sheet.pdf-mode .grid th{background:#f0f0f0}
  #sheet.pdf-mode .level-title{font-size:16px;margin:10px 0}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>G√©n√©rateur de grilles 3√ó3 ‚Äî tables de multiplication</h1>
      <div class="controls">
        <button id="regen" class="btn">üîÅ R√©g√©n√©rer</button>
        <button id="toggle" class="btn secondary">üëÅÔ∏è Afficher les corrig√©s</button>
        <button id="pdf" class="btn">üìÑ Exporter en PDF</button>
      </div>
    </header>

    <div class="card" id="sheet">
      <div class="table-select" id="tableSelect">
        <span>Choisis les tables (2 √† 12) :</span>
      </div>
      <div class="meta">
        <div>Nom : <span class="line" style="width:360px"></span></div>
        <div>Classe : <span class="line" style="width:180px"></span></div>
        <div>Date : ____ / ____ / ______</div>
      </div>

      <div class="gridbox" id="game1">
        <section style="grid-column:1/-1"><h3 class="level-title">Jeu 1</h3></section>
        <section>
          <h4 class="level-title">Niveau 1 ‚Äî 1re ligne & 1re colonne donn√©es</h4>
          <table class="grid" id="g1a"></table>
        </section>
        <section>
          <h4 class="level-title">Niveau 2 ‚Äî 1re ligne + quelques r√©ponses</h4>
          <table class="grid" id="g2a"></table>
        </section>
        <section>
          <h4 class="level-title">Niveau 3 ‚Äî indices (solution unique)</h4>
          <table class="grid" id="g3a"></table>
        </section>
      </div>

      <hr>

      <div class="gridbox" id="game2">
        <section style="grid-column:1/-1"><h3 class="level-title">Jeu 2</h3></section>
        <section>
          <h4 class="level-title">Niveau 1 ‚Äî 1re ligne & 1re colonne donn√©es</h4>
          <table class="grid" id="g1b"></table>
        </section>
        <section>
          <h4 class="level-title">Niveau 2 ‚Äî 1re ligne + quelques r√©ponses</h4>
          <table class="grid" id="g2b"></table>
        </section>
        <section>
          <h4 class="level-title">Niveau 3 ‚Äî indices (solution unique)</h4>
          <table class="grid" id="g3b"></table>
        </section>
      </div>

      <hr>

      <div class="gridbox" id="game3">
        <section style="grid-column:1/-1"><h3 class="level-title">Jeu 3</h3></section>
        <section>
          <h4 class="level-title">Niveau 1 ‚Äî 1re ligne & 1re colonne donn√©es</h4>
          <table class="grid" id="g1c"></table>
        </section>
        <section>
          <h4 class="level-title">Niveau 2 ‚Äî 1re ligne + quelques r√©ponses</h4>
          <table class="grid" id="g2c"></table>
        </section>
        <section>
          <h4 class="level-title">Niveau 3 ‚Äî indices (solution unique)</h4>
          <table class="grid" id="g3c"></table>
        </section>
      </div>
    </div>
  </div>

  <script>
  // ===== Utils =====
  const randInt=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=randInt(0,i);[a[i],a[j]]=[a[j],a[i]]}return a};
  const cell=(c,t='td')=>`<${t}>${c}</${t}>`;
  const blank='&nbsp;';

  const toggleBtn=document.getElementById('toggle');
  const tableSelect=document.getElementById('tableSelect');

  // Cases √† cocher 2..12
  for(let i=2;i<=12;i++){
    const label=document.createElement('label');
    label.innerHTML=`<input type='checkbox' value='${i}' ${i<=9?'checked':''}> ${i}`;
    tableSelect.appendChild(label);
  }
  const getSelectedTables=()=>[...tableSelect.querySelectorAll('input:checked')].map(x=>+x.value);

  let showSolutions=false;
  const games=['a','b','c'];
  const state={};
  games.forEach(g=>state[g]={rows1:[],cols1:[],rows2:[],cols2:[],rows3:[],cols3:[],mask1:new Set(),mask2:new Set(),mask3:new Set()});

  function genGrid(rows,cols,mask,{showTop=true, showLeft=true}={}){
    const header=['√ó',...cols];
    let html='<tr>' + header.map((v,i)=>`<th>${i===0 ? '√ó' : (showTop? v : blank)}</th>`).join('') + '</tr>';
    for(let r=0;r<3;r++){
      html+=`<tr><th>${showLeft? rows[r] : blank}</th>`;
      for(let c=0;c<3;c++){
        const val=rows[r]*cols[c];
        const idx=r*3+c;
        const reveal = showSolutions || mask.has(idx);
        html+=`<td>${reveal?val:blank}</td>`;
      }
      html+='</tr>';
    }
    return html;
  }

  function countSolutionsUnique(pool, rows, cols, mask){
    const P=new Set(pool);
    const rowC=[new Set(),new Set(),new Set()];
    const colC=[new Set(),new Set(),new Set()];
    const revealed=[]; for(let i=0;i<9;i++) if(mask.has(i)) revealed.push(i);
    for(let r=0;r<3;r++){
      for(const v of P){
        let ok=true;
        for(const idx of revealed){
          const rr=(idx/3)|0, cc=idx%3; if(rr!==r) continue;
          const prod=rows[rr]*cols[cc];
          if(prod%v!==0 || !P.has(prod/v)){ ok=false; break; }
        }
        if(ok) rowC[r].add(v);
      }
    }
    for(let c=0;c<3;c++){
      for(const v of P){
        let ok=true;
        for(const idx of revealed){
          const rr=(idx/3)|0, cc=idx%3; if(cc!==c) continue;
          const prod=rows[rr]*cols[cc];
          if(prod%v!==0 || !P.has(prod/v)){ ok=false; break; }
        }
        if(ok) colC[c].add(v);
      }
    }
    const usedR=new Set(), usedC=new Set();
    let solutions=0;
    const rOrder=[0,1,2].sort((a,b)=>rowC[a].size-rowC[b].size);
    const cOrder=[0,1,2].sort((a,b)=>colC[a].size-colC[b].size);
    const assignCols=(assignR)=>{
      const Cvals=[null,null,null];
      const dfsC=(i)=>{
        if(i===3){
          for(const idx of revealed){
            const rr=(idx/3)|0, cc=idx%3;
            if(assignR[rr]*Cvals[cc]!==rows[rr]*cols[cc]) return;
          }
          solutions++; return;
        }
        const c=cOrder[i];
        for(const v of colC[c]){
          if(usedC.has(v)) continue;
          Cvals[c]=v; usedC.add(v);
          dfsC(i+1);
          if(solutions>1) return;
          usedC.delete(v);
        }
      };
      dfsC(0);
    };
    const Rvals=[null,null,null];
    const dfsR=(i)=>{
      if(i===3){ assignCols(Rvals); return; }
      const r=rOrder[i];
      for(const v of rowC[r]){
        if(usedR.has(v)) continue;
        Rvals[r]=v; usedR.add(v);
        dfsR(i+1);
        if(solutions>1) return;
        usedR.delete(v);
      }
    };
    dfsR(0);
    return solutions;
  }

  function pickTriple(pool, avoidSet=new Set(), avoidExactly=null){
    const choices=pool.filter(v=>!avoidSet.has(v));
    let triple;
    if(choices.length>=3){ triple=shuffle(choices.slice()).slice(0,3); }
    else { triple=shuffle(pool.slice()).slice(0,3); }
    if(avoidExactly && new Set(triple).size===new Set(avoidExactly).size && triple.every(v=>avoidExactly.includes(v))){
      const others=pool.filter(v=>!avoidExactly.includes(v));
      if(others.length){ triple[0]=others[0]; }
    }
    return triple;
  }

  function renderGame(gkey){
    const pool=[...getSelectedTables()];
    if(pool.length<3){ alert('S√©lectionne au moins 3 tables.'); return; }
    const S=state[gkey];
    const usedR=new Set(), usedC=new Set();
    S.rows1=pickTriple(pool, usedR); S.rows1.forEach(v=>usedR.add(v));
    S.cols1=pickTriple(pool, usedC); S.cols1.forEach(v=>usedC.add(v));
    S.rows2=pickTriple(pool, usedR, S.rows1); S.rows2.forEach(v=>usedR.add(v));
    S.cols2=pickTriple(pool, usedC, S.cols1); S.cols2.forEach(v=>usedC.add(v));
    S.rows3=pickTriple(pool, usedR, S.rows2); S.cols3=pickTriple(pool, usedC, S.cols2);

    S.mask1=new Set();
    document.getElementById('g1'+gkey).innerHTML=genGrid(S.rows1,S.cols1,S.mask1,{showTop:true, showLeft:true});

    S.mask2=new Set();
    shuffle([...Array(9).keys()]).slice(0,randInt(3,5)).forEach(i=>S.mask2.add(i));
    document.getElementById('g2'+gkey).innerHTML=genGrid(S.rows2,S.cols2,S.mask2,{showTop:true, showLeft:false});

    function validMask(m){
      for(let r=0;r<3;r++){ if([0,1,2].every(c=>m.has(r*3+c))) return false; }
      for(let c=0;c<3;c++){ if([0,1,2].every(r=>m.has(r*3+c))) return false; }
      return true;
    }
    let tries=0, ok=false, target=4, m;
    while(tries<200 && !ok){
      m=new Set();
      if(target===4){
        const idxs=shuffle([...Array(9).keys()]).slice(0,4); idxs.forEach(i=>m.add(i));
        if(!validMask(m)){ tries++; continue; }
      } else {
        const colsPerm=shuffle([0,1,2]); const a=colsPerm[0], b=colsPerm[1], c=colsPerm[2];
        m=new Set([0*3+a,0*3+b,1*3+a,1*3+c,2*3+b]);
      }
      const cnt=countSolutionsUnique(pool, S.rows3, S.cols3, m);
      if(cnt===1){ ok=true; }
      else { tries++; if(tries>120 && target===4) target=5; }
    }
    if(!ok){ const colsPerm=shuffle([0,1,2]); const a=colsPerm[0], b=colsPerm[1], c=colsPerm[2]; m=new Set([0*3+a,0*3+b,1*3+a,1*3+c,2*3*b]); }
    S.mask3=m;
    document.getElementById('g3'+gkey).innerHTML=genGrid(S.rows3,S.cols3,S.mask3,{showTop:false, showLeft:false});
  }

  function renderAll(){ ['a','b','c'].forEach(renderGame); }

  document.getElementById('regen').addEventListener('click',()=>{ showSolutions=false; toggleBtn.textContent='üëÅÔ∏è Afficher les corrig√©s'; renderAll(); });
  toggleBtn.addEventListener('click',()=>{
    showSolutions=!showSolutions;
    toggleBtn.textContent = showSolutions ? 'üôà Masquer les corrig√©s' : 'üëÅÔ∏è Afficher les corrig√©s';
    ['a','b','c'].forEach(gkey=>{
      const S=state[gkey];
      document.getElementById('g1'+gkey).innerHTML=genGrid(S.rows1,S.cols1,S.mask1,{showTop:true, showLeft:true});
      document.getElementById('g2'+gkey).innerHTML=genGrid(S.rows2,S.cols2,S.mask2,{showTop:true, showLeft:false});
      document.getElementById('g3'+gkey).innerHTML=genGrid(S.rows3,S.cols3,S.mask3,{showTop:false, showLeft:false});
    });
  });

  async function exportPDF(){
    const sheet = document.querySelector('#sheet');
    if(!sheet){ alert('#sheet introuvable'); return; }
    const tableSel = document.getElementById('tableSelect');
    try{
      if(document.fonts && document.fonts.ready){ await document.fonts.ready; }
      // Activer un mode PDF: fond clair d√©j√† par d√©faut, agrandir les cellules et cacher la s√©lection des tables
      sheet.classList.add('pdf-mode');
      if(tableSel) tableSel.classList.add('pdf-hide');
      await new Promise(r=>setTimeout(r,30)); // stabilise le DOM

      if(!(window.jspdf && (window.jspdf.jsPDF||window.jspdf))){ throw new Error('jsPDF non charg√©'); }
      const jsPDFCtor = window.jspdf.jsPDF || window.jspdf;

      // Capture bitmap fiable (Firefox/Windows)
      window.scrollTo(0,0);
      const canvas = await html2canvas(sheet,{
        scale: 3,
        background: '#ffffff',
        useCORS: true,
        allowTaint: true,
        logging: false
      });

      const pdf = new jsPDFCtor({orientation:'portrait', unit:'pt', format:'a4'});
      const img = canvas.toDataURL('image/png');
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 10; // marges r√©duites pour agrandir encore
      const scale = Math.min((pageW - margin*2)/canvas.width, (pageH - margin*2)/canvas.height);
      const w = canvas.width * scale;
      const h = canvas.height * scale;
      const x = (pageW - w)/2;
      const y = (pageH - h)/2;
      pdf.addImage(img, 'PNG', x, Math.max(margin, y), w, h, undefined, 'FAST');

      // Ouverture ‚Äî blob d'abord, puis dataURL en secours (Firefox)
      try{
        const blob = pdf.output('blob');
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
      }catch(e){
        const dataUrl = pdf.output('dataurlstring');
        const win = window.open('about:blank', '_blank');
        if(win) win.location.href = dataUrl; else alert('PDF pr√™t. D√©sactive le bloqueur de pop-ups et r√©essaie.');
      }
    }catch(err){
      console.error('[PDF - html2canvas] ', err);
      alert('‚ö†Ô∏è Export PDF : √©chec. Essaie Imprimer ‚Üí Enregistrer en PDF, et dis-moi le message console.');
    } finally {
      // Revenir au mode normal √† l'√©cran
      sheet.classList.remove('pdf-mode');
      if(tableSel) tableSel.classList.remove('pdf-hide');
    }
  }

  // Render & bindings
  renderAll();
  document.getElementById('pdf').addEventListener('click', exportPDF);
  document.getElementById('tableSelect').addEventListener('change', renderAll);
  </script>
</body>
</html>
